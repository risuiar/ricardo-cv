---
import type { Lang, Translations } from "../i18n";
import type { Profile } from "../types/cv";
import { getContactData } from "../utils/security";

interface Props {
  lang: Lang;
  t: Translations;
  profile: Profile;
}

const { lang, t, profile } = Astro.props;
// Note: Astro.params is used for [lang] routes, Astro.props for direct component usage.
// Actually, let's just use Props properly.

const contactData = getContactData(false);

const colorMap = {
  blue: "bg-blue-100 text-blue-800",
  purple: "bg-purple-100 text-purple-800",
  green: "bg-green-100 text-green-800",
  amber: "bg-amber-100 text-amber-800",
  slate: "bg-slate-200 text-slate-800",
  red: "bg-red-100 text-red-800",
};
---

<div class="page max-w-[210mm] min-h-[297mm] mx-auto bg-white shadow-lg">
  <!-- Header -->
  <div
    class="bg-gradient-to-r from-slate-800 to-slate-700 text-white header-padding animate-slide-in"
  >
    <div
      class="header-flex flex flex-col gap-2 sm:gap-3 md:flex-row md:items-center md:justify-between"
    >
      <div class="text-center md:text-left flex-1 min-w-0">
        <h1
          class="text-2xl sm:text-3xl md:text-4xl font-bold mb-1 tracking-tight"
        >
          {t.header.title}
        </h1>
        <p class="text-base sm:text-lg md:text-xl text-slate-200 leading-tight">
          {profile.subtitle}
        </p>
      </div>
      <div class="self-center md:self-auto flex-shrink-0">
        <img
          src="/ricardo-profile.jpg"
          alt={t.header.portraitAlt}
          class="profile-photo"
        />
      </div>
    </div>
  </div>

  <table class="print-table">
    <thead class="print-header">
      <tr>
        <th>
          <div class="print-spacer">
            <div class="print-spacer-left"></div>
            <div class="print-spacer-right"></div>
          </div>
        </th>
      </tr>
    </thead>
    <tbody class="print-tbody">
      <tr class="print-row">
        <td class="print-cell">
          <div class="grid grid-cols-1 md:grid-cols-[280px_1fr] gap-0">
            <!-- LEFT COLUMN -->
            <div
              class="bg-slate-50 left-column-padding border-r-0 md:border-r border-slate-200 border-b md:border-b-0"
            >
              <!-- Kontakt -->
              <div class="section-item contact-section">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider section-title-spacing border-b-2 border-blue-600"
                >
                  {t.sections.contact}
                </h2>
                <div
                  class="text-xs contact-content text-slate-700 leading-relaxed"
                  id="contact-info"
                >
                  <p id="contact-address" class="hidden"></p>
                  <p id="contact-city">{contactData.city}</p>
                  <p>{t.contact.nationality}</p>
                  <p class="break-all" id="contact-email">
                    {contactData.email}
                  </p>
                  <p id="contact-phone" class="hidden"></p>
                  <p>
                    <a
                      href={t.contact.websiteUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-800 underline break-all"
                    >
                      {t.contact.website}
                    </a>
                  </p>
                  <p>
                    <a
                      href="https://www.linkedin.com/in/ricardo-voegeli/"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-800 underline break-all"
                    >
                      {t.contact.linkedin}
                    </a>
                  </p>
                  <p>
                    <a
                      href="https://github.com/risuiar"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-800 underline break-all"
                    >
                      {t.contact.github}
                    </a>
                  </p>
                  <p class="mt-3 hidden" id="extended-cv-link">
                    <a
                      href={t.contact.extendedCvUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-800 underline break-all font-medium"
                      download
                    >
                      {t.contact.extendedCv}
                    </a>
                  </p>
                </div>
              </div>

              <!-- Highlights -->
              <div class="section-item section-spacing">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 pb-2 border-b-2 border-blue-600"
                >
                  {t.sections.highlights}
                </h2>
                <div class="space-y-2 text-xs text-slate-700">
                  {
                    t.highlights.map((highlight) => (
                      <div class="flex items-start">
                        <span class="text-blue-600 mr-2">●</span>
                        <span>{highlight}</span>
                      </div>
                    ))
                  }
                </div>
              </div>

              <!-- Technische Expertise -->
              <div class="section-item section-spacing">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 pb-2 border-b-2 border-blue-600"
                >
                  {t.sections.technicalExpertise}
                </h2>
                <div class="space-y-3 text-xs text-slate-700 leading-relaxed">
                  {
                    profile.skills.map((skillGroup) => (
                      <div>
                        <span class="font-semibold text-slate-800">
                          {skillGroup.title}
                        </span>
                        <div class="flex flex-wrap gap-1 mt-1">
                          {skillGroup.items.map((item) => (
                            <span
                              class={`skill-tag inline-block ${colorMap[skillGroup.color]} px-2 py-0.5 rounded text-[10px]`}
                            >
                              {item}
                            </span>
                          ))}
                        </div>
                      </div>
                    ))
                  }
                </div>
              </div>

              <!-- Sprachen -->
              <div class="section-item">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 pb-2 border-b-2 border-blue-600"
                >
                  {t.sections.languages}
                </h2>
                <div class="space-y-2 text-xs text-slate-700">
                  <div class="flex justify-between">
                    <span>{t.languages.german}</span>
                    <span class="text-slate-500">{t.languages.b2}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>{t.languages.english}</span>
                    <span class="text-slate-500"
                      >{t.languages.professional}</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span>{t.languages.spanish}</span>
                    <span class="text-slate-500">{t.languages.native}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>{t.languages.portuguese}</span>
                    <span class="text-slate-500">{t.languages.b1}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-column-padding">
              <!-- Über mich -->
              <div class="section-item section-spacing">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 pb-2 border-b-2 border-blue-600"
                >
                  {t.sections.aboutMe}
                </h2>
                <div class="text-xs text-slate-700 leading-relaxed">
                  <p set:html={profile.aboutMe.paragraph1} />
                  {
                    profile.aboutMe.paragraph2 && (
                      <p class="mt-2">{profile.aboutMe.paragraph2}</p>
                    )
                  }
                </div>
              </div>

              <!-- Berufserfahrung -->
              <div class="section-spacing">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 pb-2 border-b-2 border-blue-600"
                >
                  {t.sections.workExperience}
                </h2>

                <!-- Job 1 (Highlighted Experience) -->
                <div class="job-item section-item">
                  <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-800">
                      {profile.experienceHighlight.title}
                    </h3>
                    <span
                      class="text-[10px] text-slate-500 whitespace-nowrap ml-2"
                    >
                      {t.workExperience.freelance.period}
                    </span>
                  </div>
                  <div class="text-xs text-slate-700 leading-relaxed space-y-2">
                    <p>{profile.experienceHighlight.description}</p>
                    {
                      profile.id === "frontend" && (
                        <div class="pl-3 border-l-2 border-blue-200 space-y-1">
                          <p class="font-semibold text-slate-800">
                            {t.workExperience.freelance.mainProject}
                          </p>
                          <ul class="space-y-1 list-none">
                            {t.workExperience.freelance.mainProjectItems.map(
                              (item) => (
                                <li class="flex items-start">
                                  <span class="text-blue-600 mr-2 text-[8px] mt-1">
                                    ▸
                                  </span>
                                  <span>{item}</span>
                                </li>
                              )
                            )}
                          </ul>
                        </div>
                      )
                    }
                  </div>
                </div>

                <!-- Job 2 -->
                <div class="job-item section-item">
                  <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-800">
                      {t.workExperience.skycell.title}
                    </h3>
                    <span
                      class="text-[10px] text-slate-500 whitespace-nowrap ml-2"
                    >
                      {t.workExperience.skycell.period}
                    </span>
                  </div>
                  <ul
                    class="text-xs text-slate-700 leading-relaxed space-y-1 list-none"
                  >
                    {
                      t.workExperience.skycell.items.map((item) => (
                        <li class="flex items-start">
                          <span class="text-blue-600 mr-2 text-[8px] mt-1">
                            ▸
                          </span>
                          <span set:html={item} />
                        </li>
                      ))
                    }
                  </ul>
                </div>

                <!-- Job 3 -->
                <div class="job-item section-item">
                  <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-800">
                      {t.workExperience.navyboot.title}
                    </h3>
                    <span
                      class="text-[10px] text-slate-500 whitespace-nowrap ml-2"
                    >
                      {t.workExperience.navyboot.period}
                    </span>
                  </div>
                  <ul
                    class="text-xs text-slate-700 leading-relaxed space-y-1 list-none"
                  >
                    {
                      t.workExperience.navyboot.items.map((item) => (
                        <li class="flex items-start">
                          <span class="text-blue-600 mr-2 text-[8px] mt-1">
                            ▸
                          </span>
                          <span set:html={item} />
                        </li>
                      ))
                    }
                  </ul>
                </div>

                <!-- Job 4 -->
                <div class="section-item">
                  <h3 class="text-xs font-bold text-slate-800 mb-2">
                    {t.workExperience.olderExperience.title}
                  </h3>
                  <div class="text-xs text-slate-700 leading-relaxed space-y-2">
                    <div>
                      <span class="font-semibold text-slate-800"
                        >{t.workExperience.olderExperience.epets}</span
                      >
                      <span> {t.workExperience.olderExperience.epetsDesc}</span>
                    </div>
                    <div>
                      <span class="font-semibold text-slate-800"
                        >{t.workExperience.olderExperience.car4you}</span
                      >
                      <span>
                        {t.workExperience.olderExperience.car4youDesc}</span
                      >
                    </div>
                    <div>
                      <span class="font-semibold text-slate-800"
                        >{t.workExperience.olderExperience.surfkitchen}</span
                      >
                      <span>
                        {t.workExperience.olderExperience.surfkitchenDesc}</span
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ausbildung -->
              <div class="section-item">
                <h2
                  class="section-title text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 pb-2 border-b-2 border-blue-600"
                >
                  {t.sections.education}
                </h2>
                <div class="space-y-2 text-xs text-slate-700">
                  <div>
                    <span class="font-semibold text-slate-800"
                      >{t.education.casAdvanced}</span
                    >
                    <span class="text-slate-500"
                      >{t.education.casAdvancedPeriod}</span
                    >
                  </div>
                  <div>
                    <span class="font-semibold text-slate-800"
                      >{t.education.cas}</span
                    >
                    <span class="text-slate-500">{t.education.casPeriod}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<style is:global>
  @import "../styles/shared-print.css";

  .skill-tag {
    transition: all 0.3s ease;
  }

  .skill-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 9999px;
    object-fit: cover;
    border: 4px solid rgba(255, 255, 255, 0.35);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    background: #fff;
    aspect-ratio: 1 / 1;
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .profile-photo {
      width: 120px;
      height: 120px;
    }
  }

  @media (min-width: 768px) {
    .profile-photo {
      width: 140px;
      height: 140px;
    }
  }

  @media (max-width: 767px) {
    .skill-tag {
      font-size: 11px;
      padding: 4px 8px;
    }
  }

  .section-spacing {
    margin-bottom: var(--spacing-lg);
  }

  @media (min-width: 768px) {
    .section-spacing {
      margin-bottom: var(--spacing-2xl);
    }
  }

  .job-item {
    margin-bottom: var(--spacing-md);
  }

  @media (min-width: 768px) {
    .job-item {
      margin-bottom: var(--spacing-xl);
    }
  }

  /* Print Table Hack - Only for CV */
  @media print {
    .print-table {
      display: table;
      width: 100%;
      border-collapse: collapse;
    }

    .print-header {
      display: table-header-group;
    }

    .print-tbody {
      display: table-row-group;
    }

    .print-row {
      display: table-row;
    }

    .print-cell {
      display: table-cell;
    }

    .print-spacer {
      height: 30px; /* Spacer height for subsequent pages */
      display: grid;
      grid-template-columns: 280px 1fr !important;
      gap: 0;
    }

    .print-spacer-left {
      background-color: #f8fafc; /* match slate-50 */
      border-right: 1px solid #e2e8f0;
      width: 100%;
      height: 100%;
    }

    .print-spacer-right {
      background-color: white;
      width: 100%;
      height: 100%;
    }

    /* CV Specific Print Overrides */
    .print-table {
      display: table !important;
      margin-top: -15mm !important; /* Pull up to hide spacer on Page 1 behind the main header */
    }

    .print-header {
      display: table-header-group !important;
    }

    .print-spacer {
      display: flex !important;
      height: 15mm;
      width: 100%;
    }

    .print-spacer-left {
      width: 280px !important;
      background-color: #f8fafc !important; /* slate-50 */
      border-right: 1px solid #e2e8f0 !important; /* slate-200 */
      box-sizing: border-box !important;
      flex-shrink: 0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .print-spacer-right {
      flex: 1 !important;
      background-color: white !important;
    }

    .header-padding {
      padding: var(--spacing-lg) var(--spacing-lg) !important;
      position: relative !important;
      z-index: 20 !important; /* Ensure it covers the spacer on Page 1 */
    }

    .profile-photo {
      width: 100px !important;
      height: 100px !important;
      aspect-ratio: 1 / 1 !important;
      border-color: #fff !important;
      box-shadow: none !important;
      margin-left: 0 !important;
      flex-shrink: 0 !important;
    }

    .header-flex {
      flex-direction: row !important;
      align-items: center !important;
      justify-content: space-between !important;
      gap: 0.75rem !important;
    }

    .header-flex > div:first-child {
      text-align: left !important;
      flex: 1 1 0% !important;
      min-width: 0 !important;
    }

    .header-flex > div:last-child {
      flex-shrink: 0 !important;
    }

    .header-flex h1 {
      margin-bottom: 0.25rem !important;
    }

    .header-flex p {
      font-size: 1rem !important;
      line-height: 1.25 !important;
    }

    .job-item {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .skill-tag:hover {
      transform: none !important;
      box-shadow: none !important;
    }

    @page :first {
      margin-top: 0 !important;
    }
  }
</style>

<script is:inline>
  (function () {
    async function n() {
      const t = new URLSearchParams(window.location.search).get("key");
      if (!t) return;
      try {
        const e = await fetch(`/api/contact?key=${encodeURIComponent(t)}`);
        if (!e.ok) return;
        const o = await e.json();
        if (!o.success || !o.data.showFull) return;
        const a = document.getElementById("contact-address"),
          r = document.getElementById("contact-city"),
          s = document.getElementById("contact-email"),
          c = document.getElementById("contact-phone"),
          i = document.getElementById("extended-cv-link"),
          d = o.data;
        (a &&
          d.address &&
          ((a.textContent = d.address), a.classList.remove("hidden")),
          r && d.city && (r.textContent = d.city),
          s && d.email && (s.textContent = d.email),
          c &&
            d.phone &&
            ((c.textContent = d.phone), c.classList.remove("hidden")),
          i && i.classList.remove("hidden"));
      } catch (t) {}
    }
    document.readyState === "loading"
      ? document.addEventListener("DOMContentLoaded", n)
      : n();
  })();
</script>
